source /opt/workshops/elastic-retry.sh
export $(curl http://kubernetes-vm:9000/env | xargs)

export INSTRUQT_TRACK_SLUG=o11y--course--field--100-otel-k8s--main

/opt/workshops/clone-code.sh -r ty-elastic/instruqt_$INSTRUQT_TRACK_SLUG -d false

# ------------- OTEL

# install ksm
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
helm install --set namespaceOverride=kube-system kube-state-metrics prometheus-community/kube-state-metrics

# ------------- DOWNGRADE HELM CLI VERSION
sudo rm /usr/local/bin/helm
wget https://get.helm.sh/helm-v3.18.4-linux-amd64.tar.gz
tar -zxvf helm-v3.18.4-linux-amd64.tar.gz 
sudo mv linux-amd64/helm /usr/local/bin/helm
rm helm-v3.18.4-linux-amd64.tar.gz 

# ------------- DEPLOY

cd /workspace/workshop
./build.sh -c $INSTRUQT_TRACK_SLUG -d true
